<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교회 MBTI 케미 체크</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💕</text></svg>">
    <meta name="description" content="교회 공동체를 위한 MBTI 케미 체크 서비스">
    
    <!-- ==================== 스타일 섹션 시작 ==================== -->
    <style>
        /* 애니메이션 효과 */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-30px,0); }
            70% { transform: translate3d(0,-15px,0); }
            90% { transform: translate3d(0,-4px,0); }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
    <!-- ==================== 스타일 섹션 끝 ==================== -->
</head>
<body>
    <div id="root"></div>

    <!-- ==================== 설정 섹션 시작 ==================== -->
    <script>
    // ========== CONFIG ==========
    const CONFIG = {
        // MBTI 타입 목록
        MBTI_TYPES: [
            'INTJ', 'INTP', 'ENTJ', 'ENTP',
            'INFJ', 'INFP', 'ENFJ', 'ENFP',
            'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ',
            'ISTP', 'ISFP', 'ESTP', 'ESFP'
        ],
        
        // 관리자 비밀번호
        ADMIN_PASSWORDS: ['admin2024', '교회관리자'],
        
        // 최대 기록 저장 수
        MAX_HISTORY_ITEMS: 50,
        
        // 로딩 시간 (밀리초)
        LOADING_TIME: 2000,
        
        // 점수 범위
        SCORE_RANGE: { MIN: 25, MAX: 100 },
        
        // 나이 그룹 설정
        AGE_GROUPS: [
            { value: '10s', text: '10대', minAge: 10, maxAge: 19 },
            { value: '20s', text: '20대', minAge: 20, maxAge: 29 },
            { value: '30s', text: '30대', minAge: 30, maxAge: 39 },
            { value: '40s', text: '40대', minAge: 40, maxAge: 49 },
            { value: '50s', text: '50대', minAge: 50, maxAge: 59 },
            { value: '60s', text: '60대 이상', minAge: 60, maxAge: 100 }
        ]
    };
    </script>
    <!-- ==================== 설정 섹션 끝 ==================== -->

    <!-- ==================== 매칭 알고리즘 섹션 시작 ==================== -->
    <script>
    // ========== MATCHING ALGORITHM ==========
    const MatchingAlgorithm = {
        // 기본 호환성 점수 테이블
        baseCompatibility: {
            'ENFP-INFJ': 90, 'INFJ-ENFP': 90,
            'ESFJ-ISFP': 85, 'ISFP-ESFJ': 85,
            'ENTJ-INTP': 82, 'INTP-ENTJ': 82,
            'ESTJ-ISFJ': 80, 'ISFJ-ESTJ': 80,
            'ENFJ-INFP': 78, 'INFP-ENFJ': 78,
            'ESTP-ISFJ': 75, 'ISFJ-ESTP': 75,
            'ISTJ-ESFP': 70, 'ESFP-ISTJ': 70,
            'ISTP-ENTJ': 68, 'ENTJ-ISTP': 68,
            'ENTP-ISFJ': 65, 'ISFJ-ENTP': 65,
            'INTJ-ESFP': 45, 'ESFP-INTJ': 45,
            'INTP-ESFJ': 48, 'ESFJ-INTP': 48,
            'ISFP-ESTJ': 50, 'ESTJ-ISFP': 50,
        },
        
        // 이름 기반 시드값 생성 (일관성 유지)
        getNameSeed: function(name1, name2) {
            const combined = (name1 + name2).split('').reduce((acc, char) => {
                return acc + char.charCodeAt(0);
            }, 0);
            return combined % 1000;
        },
        
        // 유사 랜덤 함수 (시드 기반)
        seededRandom: function(seed, min, max) {
            const x = Math.sin(seed) * 10000;
            const random = x - Math.floor(x);
            return Math.floor(random * (max - min + 1)) + min;
        },
        
        // 성별 조합에 따른 보너스 점수
        getGenderBonus: function(gender1, gender2) {
            if (!gender1 || !gender2) return 0;
            
            if (gender1 !== gender2) {
                // 이성 조합: ±5점 변동
                return this.seededRandom(Date.now(), -5, 5);
            } else {
                // 동성 조합: 안정적인 우정 보너스
                return 3;
            }
        },
        
        // 나이 차이에 따른 보너스 점수
        getAgeBonus: function(ageGroup1, ageGroup2) {
            if (!ageGroup1 || !ageGroup2) return 0;
            
            const age1 = CONFIG.AGE_GROUPS.find(g => g.value === ageGroup1);
            const age2 = CONFIG.AGE_GROUPS.find(g => g.value === ageGroup2);
            
            if (!age1 || !age2) return 0;
            
            const ageDiff = Math.abs(age1.minAge - age2.minAge);
            
            if (ageDiff === 0) return 8;  // 동갑 - 높은 공감대
            if (ageDiff <= 10) return 3;  // 또래 - 편안한 관계
            return 5;  // 나이차이 - 멘토링 관계 보너스
        },
        
        // 특별한 조합 보너스/패널티
        getSpecialBonus: function(mbti1, mbti2, seed) {
            const special = this.seededRandom(seed + 200, 1, 100);
            
            if (special <= 5) return 20;   // 특별한 케미 (5%)
            if (special <= 20) return 10;  // 좋은 케미 (15%)
            if (special >= 90) return -10; // 나쁜 케미 (10%)
            if (special >= 97) return -15; // 특별한 갈등 (3%)
            
            return 0; // 보통 (67%)
        },
        
        // 개선된 케미 계산 (성별, 나이 반영)
        calculateChemistry: function(person1, person2) {
            const mbti1 = person1.mbti;
            const mbti2 = person2.mbti;
            const nameSeed = this.getNameSeed(person1.name, person2.name);
            
            // 기본 점수 계산
            let baseScore = 60;
            const key = mbti1 + '-' + mbti2;
            
            if (mbti1 === mbti2) {
                baseScore = this.seededRandom(nameSeed, 75, 95);
            } else if (this.baseCompatibility[key]) {
                baseScore = this.baseCompatibility[key];
            } else {
                // 개별 차원별 호환성 계산
                let compatibilityScore = 50;
                
                // E/I 호환성
                if ((mbti1[0] === 'E' && mbti2[0] === 'I') || (mbti1[0] === 'I' && mbti2[0] === 'E')) {
                    compatibilityScore += 15;
                } else if (mbti1[0] === mbti2[0]) {
                    compatibilityScore += 8;
                }
                
                // S/N 호환성
                if (mbti1[1] === mbti2[1]) {
                    compatibilityScore += 12;
                } else {
                    compatibilityScore += 5;
                }
                
                // T/F 호환성
                if ((mbti1[2] === 'T' && mbti2[2] === 'F') || (mbti1[2] === 'F' && mbti2[2] === 'T')) {
                    compatibilityScore += 10;
                } else {
                    compatibilityScore += 7;
                }
                
                // J/P 호환성
                if ((mbti1[3] === 'J' && mbti2[3] === 'P') || (mbti1[3] === 'P' && mbti2[3] === 'J')) {
                    compatibilityScore += 13;
                } else {
                    compatibilityScore += 6;
                }
                
                baseScore = compatibilityScore;
            }
            
            // 개인차 변동 요소
            const personalVariation = this.seededRandom(nameSeed + 100, -15, 15);
            
            // 특별한 조합 보너스
            const specialBonus = this.getSpecialBonus(mbti1, mbti2, nameSeed);
            
            // 성별 보너스 (새로 추가)
            const genderBonus = this.getGenderBonus(person1.gender, person2.gender);
            
            // 나이 보너스 (새로 추가)
            const ageBonus = this.getAgeBonus(person1.ageGroup, person2.ageGroup);
            
            // 최종 점수 계산
            let finalScore = baseScore + personalVariation + specialBonus + genderBonus + ageBonus;
            
            // 점수 범위 제한
            finalScore = Math.max(CONFIG.SCORE_RANGE.MIN, Math.min(CONFIG.SCORE_RANGE.MAX, finalScore));
            
            return finalScore;
        },
        
        // 세부 점수 계산
        getDetailedScores: function(person1, person2) {
            const baseScore = this.calculateChemistry(person1, person2);
            const nameSeed = this.getNameSeed(person1.name, person2.name);
            
            return {
                travel: Math.max(20, Math.min(100, baseScore + this.seededRandom(nameSeed + 1, -20, 20))),
                faith: Math.max(20, Math.min(100, baseScore + this.seededRandom(nameSeed + 2, -15, 15))),
                conversation: Math.max(20, Math.min(100, baseScore + this.seededRandom(nameSeed + 3, -25, 25))),
                teamwork: Math.max(20, Math.min(100, baseScore + this.seededRandom(nameSeed + 4, -18, 18))),
                service: Math.max(20, Math.min(100, baseScore + this.seededRandom(nameSeed + 5, -15, 15)))
            };
        },
        
        // 케미 메시지 생성 (성별, 나이 반영)
        getChemistryMessage: function(person1, person2, score) {
            const mbti1 = person1.mbti;
            const mbti2 = person2.mbti;
            
            // 같은 MBTI
            if (mbti1 === mbti2) {
                return "찐친 될 확률 99%! 같은 MBTI끼리는 서로를 너무 잘 이해해서 금세 편안한 사이가 될 것 같아요!";
            }
            
            // 성별에 따른 메시지 차별화
            let genderMessage = "";
            if (person1.gender && person2.gender) {
                if (person1.gender !== person2.gender) {
                    genderMessage = score >= 80 ? " 특별한 설렘이 있을 수도...💕" : "";
                } else {
                    genderMessage = score >= 80 ? " 진정한 우정이 시작될 것 같아요!" : "";
                }
            }
            
            // 기본 메시지
            if (score >= 80) return "와! 정말 환상의 케미네요! 함께하면 시너지 폭발할 것 같아요!" + genderMessage;
            if (score >= 60) return "좋은 케미에요! 더 알아갈수록 케미가 업될 거예요!" + genderMessage;
            return "케미를 맞춰가는 재미가 있는 관계네요!" + genderMessage;
        }
    };
    </script>
    <!-- ==================== 매칭 알고리즘 섹션 끝 ==================== -->

    <!-- ==================== 데이터 관리 섹션 시작 ==================== -->
    <script>
    // ========== DATA MANAGER ==========
    const DataManager = {
        // 로컬 스토리지에서 데이터 불러오기
        loadFromStorage: function() {
            const savedHistory = JSON.parse(localStorage.getItem('mbtiChemistryHistory') || '[]');
            const savedUrl = localStorage.getItem('googleSheetsUrl') || '';
            return { testHistory: savedHistory, googleSheetsUrl: savedUrl };
        },
        
        // 기록 저장
        saveToHistory: async function(person1, person2, result) {
            const newRecord = {
                id: Date.now(),
                person1: person1,
                person2: person2,
                score: result.overall,
                date: new Date().toLocaleDateString('ko-KR'),
                time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
            };
            
            const currentHistory = appState.testHistory || [];
            const updatedHistory = [newRecord, ...currentHistory].slice(0, CONFIG.MAX_HISTORY_ITEMS);
            
            appState.testHistory = updatedHistory;
            localStorage.setItem('mbtiChemistryHistory', JSON.stringify(updatedHistory));
            
            return newRecord;
        },
        
        // 이름 마스킹 함수
        maskName: function(name) {
            if (appState.isAdmin) {
                return name;
            }
            
            if (name.length === 1) {
                return name;
            } else if (name.length === 2) {
                return name[0] + '*';
            } else {
                return name[0] + '*'.repeat(name.length - 1);
            }
        },
        
        // CSV 다운로드
        downloadCSV: function() {
            if (appState.testHistory.length === 0) {
                alert('다운로드할 데이터가 없습니다.');
                return;
            }

            const headers = ['날짜', '시간', '첫번째 이름', '첫번째 MBTI', '첫번째 성별', '첫번째 나이대', 
                            '두번째 이름', '두번째 MBTI', '두번째 성별', '두번째 나이대', '케미 점수'];
            const csvData = appState.testHistory.map(record => [
                record.date, 
                record.time, 
                record.person1.name, 
                record.person1.mbti,
                record.person1.gender || '-',
                record.person1.ageGroup || '-',
                record.person2.name, 
                record.person2.mbti,
                record.person2.gender || '-',
                record.person2.ageGroup || '-',
                record.score
            ]);

            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `MBTI_케미테스트_기록_${new Date().toLocaleDateString('ko-KR')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        },
        
        // 통계 계산
        getStats: function() {
            if (appState.testHistory.length === 0) {
                return {
                    totalTests: 0,
                    averageScore: 0,
                    topMBTI: '',
                    topCombo: '',
                    todayTests: 0,
                    weekTests: 0
                };
            }

            const today = new Date().toLocaleDateString('ko-KR');
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const todayTests = appState.testHistory.filter(record => record.date === today).length;
            const weekTests = appState.testHistory.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= oneWeekAgo;
            }).length;

            const totalScore = appState.testHistory.reduce((sum, record) => sum + record.score, 0);
            const mbtiCount = {};
            const comboCount = {};

            appState.testHistory.forEach(record => {
                mbtiCount[record.person1.mbti] = (mbtiCount[record.person1.mbti] || 0) + 1;
                mbtiCount[record.person2.mbti] = (mbtiCount[record.person2.mbti] || 0) + 1;
                const combo = [record.person1.mbti, record.person2.mbti].sort().join('-');
                comboCount[combo] = (comboCount[combo] || 0) + 1;
            });

            const topMBTI = Object.keys(mbtiCount).reduce((a, b) => mbtiCount[a] > mbtiCount[b] ? a : b, '');
            const topCombo = Object.keys(comboCount).reduce((a, b) => comboCount[a] > comboCount[b] ? a : b, '');

            return {
                totalTests: appState.testHistory.length,
                averageScore: Math.round(totalScore / appState.testHistory.length),
                topMBTI: topMBTI,
                topCombo: topCombo,
                todayTests: todayTests,
                weekTests: weekTests
            };
        }
    };
    </script>
    <!-- ==================== 데이터 관리 섹션 끝 ==================== -->

    <!-- ==================== UI 컴포넌트 섹션 시작 ==================== -->
    <script>
    // ========== UI COMPONENTS ==========
    const UIComponents = {
        // Input 컴포넌트
        createInput: function(type, placeholder, value, onchange, className = '', id = '') {
            return `<input type="${type}" placeholder="${placeholder}" value="${value}" 
                ${id ? `id="${id}"` : ''}
                oninput="${onchange}" 
                onblur="render()"
                class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-600 focus:outline-none transition-colors ${className}">`;
        },
        
        // Select 컴포넌트
        createSelect: function(value, onchange, options, className = '') {
            const optionHtml = options.map(opt => 
                `<option value="${opt.value}" ${opt.value === value ? 'selected' : ''}>${opt.text}</option>`
            ).join('');
            
            return `<select onchange="${onchange}" class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-600 focus:outline-none transition-colors ${className}">
                ${optionHtml}
            </select>`;
        },
        
        // Radio 버튼 그룹 컴포넌트 (성별 선택용)
        createRadioGroup: function(name, value, options, onchange) {
            return `<div class="flex space-x-4 justify-center">
                ${options.map(opt => `
                    <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-gray-50">
                        <input type="radio" name="${name}" value="${opt.value}" 
                            ${value === opt.value ? 'checked' : ''} 
                            onchange="${onchange}"
                            class="w-4 h-4 text-blue-600">
                        <span class="text-gray-700">${opt.text}</span>
                    </label>
                `).join('')}
            </div>`;
        },
        
        // Button 컴포넌트
        createButton: function(text, onclick, className = '') {
            return `<button onclick="${onclick}" class="${className}">${text}</button>`;
        },
        
        // 점수 색상 결정
        getScoreColor: function(score) {
            if (score >= 80) return 'text-green-600';
            if (score >= 60) return 'text-blue-600';
            return 'text-orange-600';
        },
        
        // 점수 이모지 결정
        getScoreEmoji: function(score) {
            if (score >= 90) return '🏆';
            if (score >= 80) return '🔥';
            if (score >= 60) return '✨';
            return '💫';
        }
    };
    </script>
    <!-- ==================== UI 컴포넌트 섹션 끝 ==================== -->

    <!-- ==================== 메인 앱 섹션 시작 ==================== -->
    <script>
    // ========== MAIN APPLICATION ==========
    
    // 전역 상태 관리
    let appState = {
        currentStep: 'input',
        person1: { name: '', mbti: '', gender: '', ageGroup: '' },
        person2: { name: '', mbti: '', gender: '', ageGroup: '' },
        result: null,
        testHistory: [],
        showHistory: false,
        showCelebration: false,
        showSettings: false,
        showAdmin: false,
        isAdmin: false,
        adminPassword: '',
        searchTerm: '',
        dateFilter: 'all',
        googleSheetsUrl: ''
    };

    // 상태 업데이트 함수
    function updateState(newState) {
        appState = { ...appState, ...newState };
        
        // 입력 관련 상태는 실제 DOM 업데이트만 하고 전체 렌더링은 하지 않음
        if (newState.person1 || newState.person2 || newState.searchTerm || newState.adminPassword) {
            return;
        } else {
            render();
        }
    }

    // 즉시 상태 업데이트
    function updateStateImmediate(newState) {
        appState = { ...appState, ...newState };
        render();
    }

    // 테스트 제출 핸들러
    function handleSubmit() {
        if (!appState.person1.name || !appState.person1.mbti || 
            !appState.person2.name || !appState.person2.mbti) {
            alert('이름과 MBTI를 모두 입력해주세요!');
            return;
        }

        updateStateImmediate({ currentStep: 'loading' });
        
        setTimeout(() => {
            const overallScore = MatchingAlgorithm.calculateChemistry(appState.person1, appState.person2);
            const message = MatchingAlgorithm.getChemistryMessage(appState.person1, appState.person2, overallScore);
            const detailedScores = MatchingAlgorithm.getDetailedScores(appState.person1, appState.person2);
            
            const finalResult = {
                overall: overallScore,
                message: message,
                detailed: detailedScores
            };
            
            updateStateImmediate({ result: finalResult, currentStep: 'result' });
            DataManager.saveToHistory(appState.person1, appState.person2, finalResult);
            
            if (overallScore >= 90) {
                updateStateImmediate({ showCelebration: true });
                setTimeout(() => updateStateImmediate({ showCelebration: false }), 3000);
            }
        }, CONFIG.LOADING_TIME);
    }

    // 테스트 리셋
    function resetTest() {
        updateStateImmediate({
            currentStep: 'input',
            person1: { name: '', mbti: '', gender: '', ageGroup: '' },
            person2: { name: '', mbti: '', gender: '', ageGroup: '' },
            result: null,
            showCelebration: false
        });
    }

    // 관리자 로그인
    function handleAdminLogin() {
        if (CONFIG.ADMIN_PASSWORDS.includes(appState.adminPassword)) {
            updateStateImmediate({ isAdmin: true, showAdmin: true, adminPassword: '' });
        } else {
            alert('관리자 비밀번호가 틀렸습니다.');
            updateStateImmediate({ adminPassword: '' });
        }
    }

    // 메인 렌더링 함수
    function render() {
        const root = document.getElementById('root');
        
        // 관리자 로그인 화면
        if (appState.showAdmin && !appState.isAdmin) {
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">👑</div>
                            <h2 class="text-2xl font-bold text-gray-800">관리자 로그인</h2>
                            <p class="text-gray-600 mt-2">관리자 대시보드에 접근하려면 비밀번호를 입력하세요</p>
                        </div>
                        <div class="space-y-4">
                            ${UIComponents.createInput('password', '관리자 비밀번호', appState.adminPassword, 
                                "updateState({adminPassword: this.value})", 
                                'onkeypress="if(event.key===\'Enter\')handleAdminLogin()"', 'admin-password')}
                            ${UIComponents.createButton('로그인', 'handleAdminLogin()', 
                                'w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-2xl hover:from-purple-700 hover:to-indigo-700 transition-all duration-200')}
                            ${UIComponents.createButton('취소', 'updateStateImmediate({showAdmin: false, adminPassword: ""})', 
                                'w-full bg-gray-100 text-gray-700 font-medium py-3 px-6 rounded-2xl hover:bg-gray-200 transition-all')}
                        </div>
                        <div class="mt-6 p-3 bg-blue-50 rounded-xl text-center">
                            <p class="text-xs text-blue-600">💡 힌트: 기본 비밀번호는 "admin2024" 또는 "교회관리자" 입니다</p>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // 관리자 대시보드
        if (appState.showAdmin && appState.isAdmin) {
            const stats = DataManager.getStats();
            
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-50 p-4">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <span class="text-3xl mr-3">👑</span>
                                    <h1 class="text-3xl font-bold text-gray-800">관리자 대시보드</h1>
                                </div>
                                ${UIComponents.createButton('로그아웃', 'updateStateImmediate({isAdmin: false, showAdmin: false})', 
                                    'bg-red-100 text-red-700 px-4 py-2 rounded-xl hover:bg-red-200 transition-all')}
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-xl">🔍</span>
                                    ${UIComponents.createInput('text', '이름 또는 MBTI로 검색...', appState.searchTerm, 
                                        'updateState({searchTerm: this.value})', 'pl-10', 'admin-search')}
                                </div>
                                ${UIComponents.createSelect(appState.dateFilter, 'updateStateImmediate({dateFilter: this.value})', [
                                    {value: 'all', text: '전체 기간'},
                                    {value: 'today', text: '오늘'},
                                    {value: 'week', text: '최근 1주일'},
                                    {value: 'month', text: '최근 1개월'}
                                ])}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-gray-700">총 테스트 수</h3>
                                    <span class="text-2xl">📊</span>
                                </div>
                                <div class="text-3xl font-bold text-blue-600">${stats.totalTests}</div>
                                <p class="text-sm text-gray-500 mt-2">전체 케미 테스트 횟수</p>
                            </div>

                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-gray-700">평균 케미 점수</h3>
                                    <span class="text-2xl">📈</span>
                                </div>
                                <div class="text-3xl font-bold text-green-600">${stats.averageScore}점</div>
                                <p class="text-sm text-gray-500 mt-2">전체 테스트 평균</p>
                            </div>

                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-gray-700">최다 참여 MBTI</h3>
                                    <span class="text-2xl">⭐</span>
                                </div>
                                <div class="text-3xl font-bold text-yellow-600">${stats.topMBTI || '-'}</div>
                                <p class="text-sm text-gray-500 mt-2">가장 많이 테스트한 유형</p>
                            </div>

                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-gray-700">오늘 테스트</h3>
                                    <span class="text-2xl">📅</span>
                                </div>
                                <div class="text-3xl font-bold text-purple-600">${stats.todayTests}</div>
                                <p class="text-sm text-gray-500 mt-2">금일 진행된 테스트</p>
                            </div>

                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-gray-700">인기 조합</h3>
                                    <span class="text-2xl">💕</span>
                                </div>
                                <div class="text-xl font-bold text-red-600">${stats.topCombo || '-'}</div>
                                <p class="text-sm text-gray-500 mt-2">가장 많이 테스트된 조합</p>
                            </div>

                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold text-gray-700">이번 주 테스트</h3>
                                    <span class="text-2xl">📊</span>
                                </div>
                                <div class="text-3xl font-bold text-indigo-600">${stats.weekTests}</div>
                                <p class="text-sm text-gray-500 mt-2">최근 7일간 테스트</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-800">상세 기록</h2>
                                <div class="text-sm text-gray-500">총 ${appState.testHistory.length}개 기록</div>
                            </div>
                            
                            ${appState.testHistory.length === 0 ? 
                                '<div class="text-center py-12 text-gray-500">기록이 없습니다.</div>' :
                                `<div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="border-b-2 border-gray-200">
                                                <th class="text-left py-3 px-4 font-semibold text-gray-700">날짜</th>
                                                <th class="text-left py-3 px-4 font-semibold text-gray-700">시간</th>
                                                <th class="text-left py-3 px-4 font-semibold text-gray-700">첫 번째</th>
                                                <th class="text-left py-3 px-4 font-semibold text-gray-700">두 번째</th>
                                                <th class="text-center py-3 px-4 font-semibold text-gray-700">케미 점수</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${appState.testHistory.map((record, index) => `
                                                <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                                                    <td class="py-3 px-4">${record.date}</td>
                                                    <td class="py-3 px-4">${record.time}</td>
                                                    <td class="py-3 px-4">
                                                        ${record.person1.name} (${record.person1.mbti})
                                                        ${record.person1.gender ? `<span class="text-xs text-gray-500">${record.person1.gender === 'M' ? '남' : '여'}</span>` : ''}
                                                        ${record.person1.ageGroup ? `<span class="text-xs text-gray-500">${CONFIG.AGE_GROUPS.find(g => g.value === record.person1.ageGroup)?.text || ''}</span>` : ''}
                                                    </td>
                                                    <td class="py-3 px-4">
                                                        ${record.person2.name} (${record.person2.mbti})
                                                        ${record.person2.gender ? `<span class="text-xs text-gray-500">${record.person2.gender === 'M' ? '남' : '여'}</span>` : ''}
                                                        ${record.person2.ageGroup ? `<span class="text-xs text-gray-500">${CONFIG.AGE_GROUPS.find(g => g.value === record.person2.ageGroup)?.text || ''}</span>` : ''}
                                                    </td>
                                                    <td class="py-3 px-4 text-center">
                                                        <span class="font-bold ${UIComponents.getScoreColor(record.score)}">${record.score}점 ${UIComponents.getScoreEmoji(record.score)}</span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                    
                                    <div class="mt-6 pt-6 border-t border-gray-200">
                                        <h3 class="font-medium text-gray-700 mb-3">관리자 도구</h3>
                                        <div class="flex space-x-3">
                                            ${UIComponents.createButton('📥 CSV 다운로드', 'DataManager.downloadCSV()', 
                                                'flex-1 bg-green-100 text-green-700 font-medium py-3 px-4 rounded-2xl hover:bg-green-200 transition-all')}
                                            ${UIComponents.createButton('🗑️ 모든 기록 삭제', 
                                                'if(confirm("정말로 모든 기록을 삭제하시겠습니까?")) { localStorage.removeItem("mbtiChemistryHistory"); updateState({testHistory: []}); alert("모든 기록이 삭제되었습니다."); }', 
                                                'flex-1 bg-red-100 text-red-700 font-medium py-3 px-4 rounded-2xl hover:bg-red-200 transition-all')}
                                        </div>
                                    </div>
                                </div>`
                            }
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // 설정 화면
        if (appState.showSettings) {
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-3xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                    <span class="text-2xl mr-2">⚙️</span>
                                    설정
                                </h2>
                                ${UIComponents.createButton('✕', 'updateStateImmediate({showSettings: false})', 
                                    'text-gray-500 hover:text-gray-700 text-2xl')}
                            </div>
                            
                            <div class="space-y-4">
                                <div class="text-center">
                                    <h3 class="font-medium text-gray-700 mb-4">관리자 도구</h3>
                                    ${UIComponents.createButton('👑 관리자 대시보드', 'updateStateImmediate({showAdmin: true, showSettings: false})', 
                                        'w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-2xl hover:from-purple-700 hover:to-indigo-700 transition-all duration-200')}
                                    <p class="text-xs text-gray-500 mt-2">
                                        📊 전체 통계, 데이터 관리, CSV 다운로드
                                    </p>
                                </div>
                                
                                <div class="border-t pt-4">
                                    <h3 class="font-medium text-gray-700 mb-3">앱 정보</h3>
                                    <div class="bg-blue-50 rounded-xl p-4 text-center">
                                        <p class="text-sm text-blue-800 font-medium mb-2">🏛️ 교회 MBTI 케미 체크 v2.0</p>
                                        <p class="text-xs text-blue-600">
                                            • 5개 영역별 세부 분석<br>
                                            • 성별/나이 반영 매칭<br>
                                            • 개인정보 보호 (이름 마스킹)<br>
                                            • 관리자용 통계 대시보드
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            ${UIComponents.createButton('완료', 'updateStateImmediate({showSettings: false})', 
                                'w-full mt-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-6 rounded-2xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200')}
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // 기록 보기 화면
        if (appState.showHistory) {
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-3xl shadow-xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                    <span class="text-2xl mr-2">📋</span>
                                    케미 테스트 기록
                                </h2>
                                <div class="flex space-x-2">
                                    ${UIComponents.createButton('⚙️', 'updateState({showSettings: true})', 
                                        'p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-100')}
                                    ${UIComponents.createButton('✕', 'updateState({showHistory: false})', 
                                        'text-gray-500 hover:text-gray-700 text-xl')}
                                </div>
                            </div>
                            
                            ${appState.testHistory.length === 0 ? 
                                '<div class="text-center py-8"><p class="text-gray-500">아직 테스트 기록이 없어요</p></div>' :
                                `<div class="space-y-3 max-h-96 overflow-y-auto">
                                    ${appState.testHistory.map(record => `
                                        <div class="bg-gray-50 rounded-2xl p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center space-x-2">
                                                    <span class="font-medium text-blue-600">${DataManager.maskName(record.person1.name)}</span>
                                                    <span class="text-xs text-gray-500">(${record.person1.mbti})</span>
                                                    <span class="text-red-500">💕</span>
                                                    <span class="font-medium text-purple-600">${DataManager.maskName(record.person2.name)}</span>
                                                    <span class="text-xs text-gray-500">(${record.person2.mbti})</span>
                                                </div>
                                                <span class="font-bold ${UIComponents.getScoreColor(record.score)}">
                                                    ${record.score}점 ${UIComponents.getScoreEmoji(record.score)}
                                                </span>
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ${record.date} ${record.time}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>`
                            }
                            
                            ${UIComponents.createButton('돌아가기', 'updateStateImmediate({showHistory: false})', 
                                'w-full mt-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-6 rounded-2xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200')}
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // 로딩 화면
        if (appState.currentStep === 'loading') {
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent mx-auto mb-6"></div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">케미 분석 중...</h2>
                        <p class="text-gray-600">두 분의 특별한 케미를 확인하고 있어요!</p>
                    </div>
                </div>
            `;
            return;
        }

        // 결과 화면
        if (appState.currentStep === 'result') {
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                    ${appState.showCelebration ? `
                        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                            <div class="bg-white rounded-3xl p-8 max-w-sm mx-4 text-center animate-bounce">
                                <div class="text-6xl mb-4">🎉</div>
                                <div class="text-3xl mb-2">🏆</div>
                                <h2 class="text-2xl font-bold text-yellow-600 mb-2">환상의 케미!</h2>
                                <p class="text-gray-700 mb-4">90점 이상의 놀라운 궁합이에요!</p>
                                <div class="flex justify-center space-x-2">
                                    ${'⭐'.repeat(5)}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="max-w-md mx-auto">
                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                            <div class="text-center mb-6">
                                <div class="flex items-center justify-center mb-4">
                                    <span class="text-3xl mr-2">✨</span>
                                    <h1 class="text-2xl font-bold text-gray-800">케미 분석 결과</h1>
                                    ${UIComponents.createButton('📋', 'updateStateImmediate({showHistory: true})', 
                                        'ml-4 p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-100')}
                                </div>
                                <div class="flex items-center justify-center space-x-2 mb-2">
                                    <span class="text-lg font-semibold text-blue-600">${appState.person1.name}</span>
                                    <span class="text-sm text-gray-500">(${appState.person1.mbti})</span>
                                    <span class="text-red-500">💕</span>
                                    <span class="text-lg font-semibold text-blue-600">${appState.person2.name}</span>
                                    <span class="text-sm text-gray-500">(${appState.person2.mbti})</span>
                                </div>
                            </div>
                            
                            <div class="text-center mb-6">
                                ${appState.result.overall >= 90 ? `
                                    <div class="mb-4">
                                        <div class="text-4xl mb-2">🎉🏆🎉</div>
                                        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-full inline-block text-sm font-bold">
                                            PERFECT MATCH!
                                        </div>
                                    </div>
                                ` : ''}
                                <div class="text-5xl font-bold ${UIComponents.getScoreColor(appState.result.overall)} mb-2">
                                    ${appState.result.overall}점 ${UIComponents.getScoreEmoji(appState.result.overall)}
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full transition-all duration-1000" 
                                         style="width: ${appState.result.overall}%"></div>
                                </div>
                                <p class="text-gray-700 leading-relaxed">${appState.result.message}</p>
                            </div>
                        </div>

                        <div class="space-y-4 mb-6">
                            ${[
                                { key: 'travel', label: '여행 동반자 케미', color: 'from-green-500 to-emerald-600', icon: '🗺️' },
                                { key: 'faith', label: '신앙 성장 파트너 케미', color: 'from-blue-500 to-indigo-600', icon: '📖' },
                                { key: 'conversation', label: '일상 대화 파트너 케미', color: 'from-purple-500 to-pink-600', icon: '💬' },
                                { key: 'teamwork', label: '소그룹 활동 파트너 케미', color: 'from-orange-500 to-red-600', icon: '👥' },
                                { key: 'service', label: '봉사 동역자 케미', color: 'from-teal-500 to-cyan-600', icon: '🤝' }
                            ].map(item => `
                                <div class="bg-white rounded-2xl shadow-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center">
                                            <span class="text-xl mr-2">${item.icon}</span>
                                            <span class="font-medium text-gray-800">${item.label}</span>
                                        </div>
                                        <span class="font-bold ${UIComponents.getScoreColor(appState.result.detailed[item.key])}">
                                            ${appState.result.detailed[item.key]}점
                                        </span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r ${item.color} h-2 rounded-full transition-all duration-1000" 
                                             style="width: ${appState.result.detailed[item.key]}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="flex space-x-3">
                            ${UIComponents.createButton('다시 테스트하기', 'resetTest()', 
                                'flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-6 rounded-2xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg')}
                            ${UIComponents.createButton('공유하기', `
                                const text = '${appState.person1.name}(${appState.person1.mbti})님과 ${appState.person2.name}(${appState.person2.mbti})님의 케미는 ${appState.result.overall}점! 🔥';
                                if (navigator.share) {
                                    navigator.share({title: 'MBTI 케미 체크 결과', text: text});
                                } else {
                                    navigator.clipboard.writeText(text);
                                    alert('결과가 클립보드에 복사되었습니다!');
                                }
                            `, 'bg-white border-2 border-blue-600 text-blue-600 font-bold py-3 px-6 rounded-2xl hover:bg-blue-50 transition-all duration-200 shadow-lg')}
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // 메인 입력 화면
        root.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                <div class="max-w-md mx-auto">
                    <div class="text-center mb-8 pt-8">
                        <div class="flex items-center justify-center mb-4">
                            <span class="text-2xl mr-2">💕</span>
                            <h1 class="text-xl md:text-3xl font-bold text-gray-800">MBTI 케미 체크</h1>
                            <div class="flex ml-4 space-x-2">
                                ${UIComponents.createButton('📋', 'updateState({showHistory: true})', 
                                    'p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-white hover:shadow-md transition-all cursor-pointer')}
                                ${UIComponents.createButton('⚙️', 'updateState({showSettings: true})', 
                                    'p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-white hover:shadow-md transition-all cursor-pointer')}
                            </div>
                        </div>
                        <p class="text-gray-600">두 사람의 특별한 케미를 확인해보세요!</p>
                        ${appState.testHistory.length > 0 ? 
                            `<p class="text-sm text-blue-600 mt-2">💾 ${appState.testHistory.length}개의 테스트 기록이 있어요</p>` : ''}
                    </div>

                    <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">1</span>
                                첫 번째 분
                            </h3>
                            <div class="space-y-4">
                                ${UIComponents.createInput('text', '이름을 입력해주세요', appState.person1.name, 
                                    'updateState({person1: {...appState.person1, name: this.value}})', '', 'person1-name')}
                                ${UIComponents.createSelect(appState.person1.mbti, 'updateStateImmediate({person1: {...appState.person1, mbti: this.value}})', 
                                    [{value: '', text: 'MBTI 유형을 선택해주세요'}, ...CONFIG.MBTI_TYPES.map(type => ({value: type, text: type}))])}
                                
                                <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                                    <p class="text-sm text-gray-600 text-center mb-2">선택사항 (더 정확한 케미 분석)</p>
                                    <div>
                                        <p class="text-sm text-gray-700 mb-2 text-center">성별</p>
                                        ${UIComponents.createRadioGroup('person1_gender', appState.person1.gender, 
                                            [{value: 'M', text: '남성'}, {value: 'F', text: '여성'}],
                                            'updateStateImmediate({person1: {...appState.person1, gender: this.value}})')}
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-700 mb-2 text-center">나이대</p>
                                        ${UIComponents.createSelect(appState.person1.ageGroup, 
                                            'updateStateImmediate({person1: {...appState.person1, ageGroup: this.value}})', 
                                            [{value: '', text: '나이대를 선택해주세요'}, ...CONFIG.AGE_GROUPS])}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <span class="bg-purple-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">2</span>
                                두 번째 분
                            </h3>
                            <div class="space-y-4">
                                ${UIComponents.createInput('text', '이름을 입력해주세요', appState.person2.name, 
                                    'updateState({person2: {...appState.person2, name: this.value}})', '', 'person2-name')}
                                ${UIComponents.createSelect(appState.person2.mbti, 'updateStateImmediate({person2: {...appState.person2, mbti: this.value}})', 
                                    [{value: '', text: 'MBTI 유형을 선택해주세요'}, ...CONFIG.MBTI_TYPES.map(type => ({value: type, text: type}))])}
                                
                                <div class="bg-gray-50 rounded-xl p-4 space-y-3">
                                    <p class="text-sm text-gray-600 text-center mb-2">선택사항 (더 정확한 케미 분석)</p>
                                    <div>
                                        <p class="text-sm text-gray-700 mb-2 text-center">성별</p>
                                        ${UIComponents.createRadioGroup('person2_gender', appState.person2.gender, 
                                            [{value: 'M', text: '남성'}, {value: 'F', text: '여성'}],
                                            'updateStateImmediate({person2: {...appState.person2, gender: this.value}})')}
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-700 mb-2 text-center">나이대</p>
                                        ${UIComponents.createSelect(appState.person2.ageGroup, 
                                            'updateStateImmediate({person2: {...appState.person2, ageGroup: this.value}})', 
                                            [{value: '', text: '나이대를 선택해주세요'}, ...CONFIG.AGE_GROUPS])}
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${UIComponents.createButton('케미 확인하기 →', 'handleSubmit()', 
                            'w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 px-6 rounded-2xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg')}
                    </div>

                    <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-4 text-center">
                        <p class="text-sm text-gray-600">
                            🎯 5개 영역별 세부 케미 분석<br>
                            💫 성별, 나이를 반영한 정교한 매칭<br>
                            💝 교회 공동체를 위한 특별한 케미 체크
                        </p>
                    </div>
                </div>
            </div>
        `;
    }

    // 초기 로드
    window.onload = function() {
        const loadedData = DataManager.loadFromStorage();
        appState.testHistory = loadedData.testHistory;
        appState.googleSheetsUrl = loadedData.googleSheetsUrl;
        render();
    };
    </script>
    <!-- ==================== 메인 앱 섹션 끝 ==================== -->
</body>
</html>
