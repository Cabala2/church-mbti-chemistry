<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµíšŒ MBTI ì¼€ë¯¸ ì²´í¬ v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’•</text></svg>">
    <meta name="description" content="êµíšŒ ê³µë™ì²´ë¥¼ ìœ„í•œ ê°œì„ ëœ MBTI ì¼€ë¯¸ ì²´í¬ ì„œë¹„ìŠ¤ v2.0">
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-30px,0); }
            70% { transform: translate3d(0,-15px,0); }
            90% { transform: translate3d(0,-4px,0); }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // ==========================================
        // ğŸš€ ê°œì„ ëœ MBTI ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ v2.0 í†µí•©
        // ==========================================

        // ì „ì—­ ìƒíƒœ ê´€ë¦¬ (í™•ì¥)
        let appState = {
            currentStep: 'input',
            person1: { 
                name: '', 
                mbti: '', 
                gender: '', 
                birthDate: '' 
            },
            person2: { 
                name: '', 
                mbti: '', 
                gender: '', 
                birthDate: '' 
            },
            result: null,
            testHistory: [],
            showHistory: false,
            showCelebration: false,
            showSettings: false,
            showAdmin: false,
            isAdmin: false,
            adminPassword: '',
            searchTerm: '',
            dateFilter: 'all',
            googleSheetsUrl: ''
        };

        const mbtiTypes = [
            'INTJ', 'INTP', 'ENTJ', 'ENTP',
            'INFJ', 'INFP', 'ENFJ', 'ENFP',
            'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ',
            'ISTP', 'ISFP', 'ESTP', 'ESFP'
        ];

        const genderOptions = [
            { value: '', text: 'ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”' },
            { value: 'male', text: 'ë‚¨ì„±' },
            { value: 'female', text: 'ì—¬ì„±' }
        ];

        // ==========================================
        // ğŸ¯ ê°œì„ ëœ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ í•¨ìˆ˜ë“¤
        // ==========================================

        // ë‚˜ì´ ê³„ì‚° í•¨ìˆ˜
        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        // ì„±ë³„ ì¡°í•©ì— ë”°ë¥¸ ë³´ë„ˆìŠ¤ ì ìˆ˜
        function getGenderBonus(gender1, gender2) {
            if (!gender1 || !gender2) return 0;
            
            // ë™ì„± ì¡°í•©
            if (gender1 === gender2) {
                return 2; // ìˆœìˆ˜ ìš°ì • ê´€ê³„ ì•ˆì •ì„± ë³´ë„ˆìŠ¤
            }
            
            // ì´ì„± ì¡°í•© - ì•½ê°„ì˜ ëœë¤ ìš”ì†Œ
            return Math.random() > 0.5 ? 5 : -2;
        }

        // ë‚˜ì´ ì°¨ì´ì— ë”°ë¥¸ ë³´ë„ˆìŠ¤ ì ìˆ˜
        function getAgeBonus(birthDate1, birthDate2) {
            if (!birthDate1 || !birthDate2) return 0;
            
            const age1 = calculateAge(birthDate1);
            const age2 = calculateAge(birthDate2);
            const ageDiff = Math.abs(age1 - age2);
            
            if (ageDiff <= 1) {
                return 8; // ë™ê°‘ - ìµœê³ ì˜ ê³µê°ëŒ€
            } else if (ageDiff <= 4) {
                return 6; // ë¹„ìŠ·í•œ ë˜ë˜ - í˜•ë™ìƒ ì¼€ë¯¸
            } else if (ageDiff <= 9) {
                return 3; // ì ë‹¹í•œ ì°¨ì´ - ì„œë¡œ ë°°ìš¸ ì 
            } else if (ageDiff >= 10) {
                return 5; // í° ì°¨ì´ - ë©˜í† ë§ ê´€ê³„ íŠ¹ë³„ ë³´ë„ˆìŠ¤
            }
            return 0;
        }

        // ì„±ë³„ ì¡°í•©ë³„ íŠ¹í™” ë©”ì‹œì§€ ìƒì„±
        function getGenderSpecificMessage(gender1, gender2, score) {
            if (!gender1 || !gender2) return "";
            
            const isSameGender = gender1 === gender2;
            
            if (isSameGender) {
                // ë™ì„± ì¡°í•© ë©”ì‹œì§€
                if (score >= 90) return "ğŸ’– í‰ìƒ ê°ˆ ì§„ì§œ ì°ì¹œì´ ë  ê²ƒ ê°™ì•„ìš”!";
                if (score >= 80) return "ğŸ˜Š ì§„ì •í•œ ìš°ì •ì´ ì‹œì‘ë  ê²ƒ ê°™ì•„ìš”!";
                if (score >= 60) return "ğŸ¤ í¸ì•ˆí•œ ë™ì„±ì¹œêµ¬ ì¼€ë¯¸ë„¤ìš”!";
                return "ğŸ‘« ì‹œê°„ì´ ì§€ë‚˜ë©´ì„œ ë” ê°€ê¹Œì›Œì§ˆ ìˆ˜ ìˆëŠ” ê´€ê³„ì˜ˆìš”!";
            } else {
                // ì´ì„± ì¡°í•© ë©”ì‹œì§€
                if (score >= 90) return "ğŸ’• ìš´ëª…ì ì¸ ë§Œë‚¨ì¼ ìˆ˜ë„... íŠ¹ë³„í•œ ì„¤ë ˜ì´ ìˆì„ ê±°ì˜ˆìš”!";
                if (score >= 80) return "âœ¨ íŠ¹ë³„í•œ ì„¤ë ˜ì´ ìˆì„ ìˆ˜ë„...ğŸ’•";
                if (score >= 60) return "ğŸ˜Œ ì¢‹ì€ ì´ì„±ì¹œêµ¬ê°€ ë  ìˆ˜ ìˆì–´ìš”!";
                return "ğŸ™‚ ì„œë¡œë¥¼ ì•Œì•„ê°€ëŠ” ì¬ë¯¸ê°€ ìˆëŠ” ê´€ê³„ë„¤ìš”!";
            }
        }

        // ë‚˜ì´ ì°¨ì´ë³„ ê´€ê³„ íŠ¹í™” ë©”ì‹œì§€
        function getAgeRelationshipMessage(birthDate1, birthDate2, name1, name2) {
            if (!birthDate1 || !birthDate2) return "";
            
            const age1 = calculateAge(birthDate1);
            const age2 = calculateAge(birthDate2);
            const ageDiff = Math.abs(age1 - age2);
            
            if (ageDiff <= 1) {
                return `ğŸ‚ ë™ê°‘ ì¼€ë¯¸! ê°™ì€ ì„¸ëŒ€ë¼ ê³µê°ëŒ€ê°€ ì—„ì²­ë‚  ê±°ì˜ˆìš”!`;
            } else if (ageDiff <= 4) {
                return `ğŸ‘« ${ageDiff}ì‚´ ì°¨ì´! í¸ì•ˆí•œ í˜•ë™ìƒ ê´€ê³„ê°€ ë  ê²ƒ ê°™ì•„ìš”!`;
            } else if (ageDiff <= 9) {
                return `ğŸŒŸ ${ageDiff}ì‚´ ì°¨ì´! ì„œë¡œ ë‹¤ë¥¸ ê´€ì ì„ ë°°ìš¸ ìˆ˜ ìˆëŠ” ê´€ê³„ë„¤ìš”!`;
            } else {
                const olderName = age1 > age2 ? name1 : name2;
                const youngerName = age1 > age2 ? name2 : name1;
                return `ğŸ‘¨â€ğŸ« ${ageDiff}ì‚´ ì°¨ì´! ${olderName}ë‹˜ì´ ${youngerName}ë‹˜ì˜ ì¢‹ì€ ë©˜í† ê°€ ë  ìˆ˜ ìˆì„ ê±°ì˜ˆìš”!`;
            }
        }

        // ê¸°ì¡´ MBTI ê³„ì‚° ë¡œì§ (ê°œì„ ëœ ë²„ì „)
        function calculateChemistry(mbti1, mbti2, person1Name = '', person2Name = '') {
            // ê¸°ë³¸ í˜¸í™˜ì„± ì ìˆ˜
            const baseCompatibility = {
                'ENFP-INFJ': 90, 'INFJ-ENFP': 90,
                'ESFJ-ISFP': 85, 'ISFP-ESFJ': 85,
                'ENTJ-INTP': 82, 'INTP-ENTJ': 82,
                'ESTJ-ISFJ': 80, 'ISFJ-ESTJ': 80,
                'ENFJ-INFP': 78, 'INFP-ENFJ': 78,
                'ESTP-ISFJ': 75, 'ISFJ-ESTP': 75,
                'ISTJ-ESFP': 70, 'ESFP-ISTJ': 70,
                'ISTP-ENTJ': 68, 'ENTJ-ISTP': 68,
                'ENTP-ISFJ': 65, 'ISFJ-ENTP': 65,
                'INTJ-ESFP': 45, 'ESFP-INTJ': 45,
                'INTP-ESFJ': 48, 'ESFJ-INTP': 48,
                'ISFP-ESTJ': 50, 'ESTJ-ISFP': 50,
            };

            // ì´ë¦„ ê¸°ë°˜ ì‹œë“œê°’ ìƒì„± (ì¼ê´€ì„± ìœ ì§€)
            function getNameSeed(name1, name2) {
                const combined = (name1 + name2).split('').reduce((acc, char) => {
                    return acc + char.charCodeAt(0);
                }, 0);
                return combined % 1000;
            }

            // ìœ ì‚¬ ëœë¤ í•¨ìˆ˜ (ì‹œë“œ ê¸°ë°˜)
            function seededRandom(seed, min, max) {
                const x = Math.sin(seed) * 10000;
                const random = x - Math.floor(x);
                return Math.floor(random * (max - min + 1)) + min;
            }

            const nameSeed = getNameSeed(person1Name, person2Name);
            
            // ê¸°ë³¸ ì ìˆ˜ ê³„ì‚°
            let baseScore = 60; // ê¸°ë³¸ ì ìˆ˜
            const key = mbti1 + '-' + mbti2;
            
            if (mbti1 === mbti2) {
                // ê°™ì€ MBTIì¼ ë•Œë„ ë‹¤ì–‘ì„± ì¶”ê°€
                baseScore = seededRandom(nameSeed, 75, 95);
            } else if (baseCompatibility[key]) {
                baseScore = baseCompatibility[key];
            } else {
                // ê°œë³„ ì°¨ì›ë³„ í˜¸í™˜ì„± ê³„ì‚°
                let compatibilityScore = 50;
                
                // E/I í˜¸í™˜ì„± (ì™¸í–¥/ë‚´í–¥)
                if ((mbti1[0] === 'E' && mbti2[0] === 'I') || (mbti1[0] === 'I' && mbti2[0] === 'E')) {
                    compatibilityScore += 15; // ìƒí˜¸ ë³´ì™„
                } else if (mbti1[0] === mbti2[0]) {
                    compatibilityScore += 8; // ê°™ì€ ì—ë„ˆì§€ ë°©í–¥
                }
                
                // S/N í˜¸í™˜ì„± (ê°ê°/ì§ê´€)
                if (mbti1[1] === mbti2[1]) {
                    compatibilityScore += 12; // ê°™ì€ ì •ë³´ ì²˜ë¦¬ ë°©ì‹
                } else {
                    compatibilityScore += 5; // ë‹¤ë¥¸ ê´€ì  ì œê³µ
                }
                
                // T/F í˜¸í™˜ì„± (ì‚¬ê³ /ê°ì •)
                if ((mbti1[2] === 'T' && mbti2[2] === 'F') || (mbti1[2] === 'F' && mbti2[2] === 'T')) {
                    compatibilityScore += 10; // ìƒí˜¸ ë³´ì™„
                } else {
                    compatibilityScore += 7; // ê°™ì€ ê²°ì • ë°©ì‹
                }
                
                // J/P í˜¸í™˜ì„± (íŒë‹¨/ì¸ì‹)
                if ((mbti1[3] === 'J' && mbti2[3] === 'P') || (mbti1[3] === 'P' && mbti2[3] === 'J')) {
                    compatibilityScore += 13; // ìƒí˜¸ ë³´ì™„
                } else {
                    compatibilityScore += 6; // ê°™ì€ ìƒí™œ ë°©ì‹
                }
                
                baseScore = compatibilityScore;
            }
            
            // ê°œì¸ì°¨ ë³€ë™ ìš”ì†Œ (Â±15ì  ë²”ìœ„)
            const personalVariation = seededRandom(nameSeed + 100, -15, 15);
            
            // íŠ¹ë³„í•œ ì¡°í•© ë³´ë„ˆìŠ¤/íŒ¨ë„í‹°
            const specialBonus = getSpecialBonus(mbti1, mbti2, nameSeed);
            
            // ìµœì¢… ì ìˆ˜ ê³„ì‚°
            let finalScore = baseScore + personalVariation + specialBonus;
            
            // ì ìˆ˜ ë²”ìœ„ ì œí•œ (25-100)
            finalScore = Math.max(25, Math.min(100, finalScore));
            
            return finalScore;
        }

        // íŠ¹ë³„í•œ ì¡°í•© ë³´ë„ˆìŠ¤/íŒ¨ë„í‹°
        function getSpecialBonus(mbti1, mbti2, seed) {
            function seededRandom(seed, min, max) {
                const x = Math.sin(seed) * 10000;
                const random = x - Math.floor(x);
                return Math.floor(random * (max - min + 1)) + min;
            }
            
            const special = seededRandom(seed + 200, 1, 100);
            
            // íŠ¹ë³„í•œ ì¼€ë¯¸ (5% í™•ë¥ ë¡œ +20ì )
            if (special <= 5) return 20;
            
            // ì¢‹ì€ ì¼€ë¯¸ (15% í™•ë¥ ë¡œ +10ì )  
            if (special <= 20) return 10;
            
            // ë‚˜ìœ ì¼€ë¯¸ (10% í™•ë¥ ë¡œ -10ì )
            if (special >= 90) return -10;
            
            // íŠ¹ë³„í•œ ê°ˆë“± (3% í™•ë¥ ë¡œ -15ì )
            if (special >= 97) return -15;
            
            return 0; // ë³´í†µ (67% í™•ë¥ )
        }

        // ê°œì„ ëœ ë©”ì¸ ë§¤ì¹­ í•¨ìˆ˜
        function calculateAdvancedChemistry(mbti1, mbti2, name1 = '', name2 = '', gender1 = '', gender2 = '', birthDate1 = '', birthDate2 = '') {
            // 1ë‹¨ê³„: ê¸°ì¡´ ê¸°ë³¸ MBTI í˜¸í™˜ì„± ì ìˆ˜
            let baseScore = calculateChemistry(mbti1, mbti2, name1, name2);
            
            // 2ë‹¨ê³„: ì„±ë³„ ì¡°í•© ë³´ì •
            if (gender1 && gender2) {
                const genderBonus = getGenderBonus(gender1, gender2);
                baseScore += genderBonus;
            }
            
            // 3ë‹¨ê³„: ë‚˜ì´ ì°¨ì´ ë³´ì •
            if (birthDate1 && birthDate2) {
                const ageBonus = getAgeBonus(birthDate1, birthDate2);
                baseScore += ageBonus;
            }
            
            // ì ìˆ˜ ë²”ìœ„ ì œí•œ (25-100)
            return Math.max(25, Math.min(100, baseScore));
        }

        // ê°œì„ ëœ ìƒì„¸ ì ìˆ˜ ê³„ì‚°
        function getAdvancedDetailedScores(mbti1, mbti2, name1 = '', name2 = '', gender1 = '', gender2 = '', birthDate1 = '', birthDate2 = '') {
            const baseDetailedScores = getDetailedScores(mbti1, mbti2, name1, name2);
            const genderBonus = gender1 && gender2 ? getGenderBonus(gender1, gender2) : 0;
            const ageBonus = birthDate1 && birthDate2 ? getAgeBonus(birthDate1, birthDate2) : 0;
            
            // ì˜ì—­ë³„ë¡œ ë‹¤ë¥¸ ê°€ì¤‘ì¹˜ ì ìš©
            return {
                travel: Math.max(20, Math.min(100, baseDetailedScores.travel + genderBonus * 0.8 + ageBonus * 0.6)),
                faith: Math.max(20, Math.min(100, baseDetailedScores.faith + ageBonus * 1.2)), // ë‚˜ì´ ì°¨ì´ê°€ ì‹ ì•™ì— ë” ì˜í–¥
                conversation: Math.max(20, Math.min(100, baseDetailedScores.conversation + genderBonus * 1.2 + ageBonus * 0.8)),
                teamwork: Math.max(20, Math.min(100, baseDetailedScores.teamwork + ageBonus * 1.0)),
                service: Math.max(20, Math.min(100, baseDetailedScores.service + genderBonus * 0.6 + ageBonus * 1.0))
            };
        }

        function getDetailedScores(mbti1, mbti2, person1Name = '', person2Name = '') {
            const baseScore = calculateChemistry(mbti1, mbti2, person1Name, person2Name);
            const nameSeed = (person1Name + person2Name).split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            
            // ìœ ì‚¬ ëœë¤ í•¨ìˆ˜
            function seededRandom(seed, min, max) {
                const x = Math.sin(seed) * 10000;
                const random = x - Math.floor(x);
                return Math.floor(random * (max - min + 1)) + min;
            }
            
            return {
                travel: Math.max(20, Math.min(100, baseScore + seededRandom(nameSeed + 1, -20, 20))),
                faith: Math.max(20, Math.min(100, baseScore + seededRandom(nameSeed + 2, -15, 15))),
                conversation: Math.max(20, Math.min(100, baseScore + seededRandom(nameSeed + 3, -25, 25))),
                teamwork: Math.max(20, Math.min(100, baseScore + seededRandom(nameSeed + 4, -18, 18))),
                service: Math.max(20, Math.min(100, baseScore + seededRandom(nameSeed + 5, -15, 15)))
            };
        }

        // ì¢…í•© ì¼€ë¯¸ ë©”ì‹œì§€ ìƒì„± (ê°œì„ ëœ ë²„ì „)
        function getAdvancedChemistryMessage(mbti1, mbti2, score, gender1 = '', gender2 = '', birthDate1 = '', birthDate2 = '', name1 = '', name2 = '') {
            let message = getChemistryMessage(mbti1, mbti2, score);
            
            // ì„±ë³„ íŠ¹í™” ë©”ì‹œì§€ ì¶”ê°€
            if (gender1 && gender2) {
                const genderMessage = getGenderSpecificMessage(gender1, gender2, score);
                if (genderMessage) {
                    message += ` ${genderMessage}`;
                }
            }
            
            // ë‚˜ì´ ê´€ê³„ ë©”ì‹œì§€ ì¶”ê°€
            if (birthDate1 && birthDate2 && name1 && name2) {
                const ageMessage = getAgeRelationshipMessage(birthDate1, birthDate2, name1, name2);
                if (ageMessage) {
                    message += ` ${ageMessage}`;
                }
            }
            
            return message;
        }

        function getChemistryMessage(mbti1, mbti2, score) {
            if (mbti1 === mbti2) {
                return "ì°ì¹œ ë  í™•ë¥  99%! ê°™ì€ MBTIë¼ë¦¬ëŠ” ì„œë¡œë¥¼ ë„ˆë¬´ ì˜ ì´í•´í•´ì„œ ê¸ˆì„¸ í¸ì•ˆí•œ ì‚¬ì´ê°€ ë  ê²ƒ ê°™ì•„ìš”!";
            }

            if (score >= 80) return "ì™€! ì •ë§ í™˜ìƒì˜ ì¼€ë¯¸ë„¤ìš”! í•¨ê»˜í•˜ë©´ ì‹œë„ˆì§€ í­ë°œí•  ê²ƒ ê°™ì•„ìš”!";
            if (score >= 60) return "ì¢‹ì€ ì¼€ë¯¸ì—ìš”! ë” ì•Œì•„ê°ˆìˆ˜ë¡ ì¼€ë¯¸ê°€ ì—…ë  ê±°ì˜ˆìš”!";
            return "ì¼€ë¯¸ë¥¼ ë§ì¶°ê°€ëŠ” ì¬ë¯¸ê°€ ìˆëŠ” ê´€ê³„ë„¤ìš”!";
        }

        // ==========================================
        // ğŸ”§ ê¸°ì¡´ ì•± ë¡œì§ (ìƒíƒœ ê´€ë¦¬, UI ë“±)
        // ==========================================

        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì…ë ¥ í•„ë“œëŠ” ë Œë”ë§ ìŠ¤í‚µ)
        function updateState(newState) {
            appState = { ...appState, ...newState };
            
            // ì…ë ¥ ê´€ë ¨ ìƒíƒœëŠ” ì‹¤ì œ DOM ì—…ë°ì´íŠ¸ë§Œ í•˜ê³  ì „ì²´ ë Œë”ë§ì€ í•˜ì§€ ì•ŠìŒ
            if (newState.person1 || newState.person2 || newState.searchTerm || newState.adminPassword) {
                return;
            } else {
                render();
            }
        }

        // ì¦‰ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì…ë ¥ ì´ì™¸ì˜ ê²½ìš°)
        function updateStateImmediate(newState) {
            appState = { ...appState, ...newState };
            render();
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í•¨ìˆ˜ë“¤
        function loadFromStorage() {
            const savedHistory = JSON.parse(localStorage.getItem('mbtiChemistryHistory') || '[]');
            const savedUrl = localStorage.getItem('googleSheetsUrl') || '';
            updateState({ testHistory: savedHistory, googleSheetsUrl: savedUrl });
        }

        // ê¸°ë¡ ì €ì¥ (í™•ì¥ëœ ì •ë³´ í¬í•¨)
        async function saveToHistory(result) {
            const newRecord = {
                id: Date.now(),
                person1: appState.person1,
                person2: appState.person2,
                score: result.overall,
                date: new Date().toLocaleDateString('ko-KR'),
                time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                // v2.0 ì¶”ê°€ ì •ë³´
                genderCombo: appState.person1.gender && appState.person2.gender ? 
                    `${appState.person1.gender}-${appState.person2.gender}` : '',
                ageDiff: appState.person1.birthDate && appState.person2.birthDate ? 
                    Math.abs(calculateAge(appState.person1.birthDate) - calculateAge(appState.person2.birthDate)) : null
            };
            
            const updatedHistory = [newRecord, ...appState.testHistory].slice(0, 50);
            updateState({ testHistory: updatedHistory });
            localStorage.setItem('mbtiChemistryHistory', JSON.stringify(updatedHistory));
        }

        // ì´ë¦„ ë§ˆìŠ¤í‚¹ í•¨ìˆ˜ (ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš°)
        function maskName(name) {
            if (appState.isAdmin) {
                return name;
            }
            
            if (name.length === 1) {
                return name;
            } else if (name.length === 2) {
                return name[0] + '*';
            } else {
                return name[0] + '*'.repeat(name.length - 1);
            }
        }

        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
        function handleSubmit() {
            if (!appState.person1.name || !appState.person1.mbti || !appState.person2.name || !appState.person2.mbti) {
                alert('ì´ë¦„ê³¼ MBTIëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤!');
                return;
            }

            updateStateImmediate({ currentStep: 'loading' });
            
            setTimeout(() => {
                // ê°œì„ ëœ ì¼€ë¯¸ ê³„ì‚° ì‚¬ìš©
                const overallScore = calculateAdvancedChemistry(
                    appState.person1.mbti, appState.person2.mbti,
                    appState.person1.name, appState.person2.name,
                    appState.person1.gender, appState.person2.gender,
                    appState.person1.birthDate, appState.person2.birthDate
                );
                
                // ê°œì„ ëœ ë©”ì‹œì§€ ìƒì„±
                const message = getAdvancedChemistryMessage(
                    appState.person1.mbti, appState.person2.mbti, overallScore,
                    appState.person1.gender, appState.person2.gender,
                    appState.person1.birthDate, appState.person2.birthDate,
                    appState.person1.name, appState.person2.name
                );
                
                // ê°œì„ ëœ ìƒì„¸ ì ìˆ˜ ê³„ì‚°
                const detailedScores = getAdvancedDetailedScores(
                    appState.person1.mbti, appState.person2.mbti,
                    appState.person1.name, appState.person2.name,
                    appState.person1.gender, appState.person2.gender,
                    appState.person1.birthDate, appState.person2.birthDate
                );
                
                const finalResult = {
                    overall: overallScore,
                    message: message,
                    detailed: detailedScores
                };
                
                updateStateImmediate({ result: finalResult, currentStep: 'result' });
                saveToHistory(finalResult);
                
                if (overallScore >= 90) {
                    updateStateImmediate({ showCelebration: true });
                    setTimeout(() => updateStateImmediate({ showCelebration: false }), 3000);
                }
            }, 2000);
        }

        function resetTest() {
            updateStateImmediate({
                currentStep: 'input',
                person1: { name: '', mbti: '', gender: '', birthDate: '' },
                person2: { name: '', mbti: '', gender: '', birthDate: '' },
                result: null,
                showCelebration: false
            });
        }

        function getScoreColor(score) {
            if (score >= 80) return 'text-green-600';
            if (score >= 60) return 'text-blue-600';
            return 'text-orange-600';
        }

        function getScoreEmoji(score) {
            if (score >= 90) return 'ğŸ†';
            if (score >= 80) return 'ğŸ”¥';
            if (score >= 60) return 'âœ¨';
            return 'ğŸ’«';
        }

        // ê´€ë¦¬ì ë¡œê·¸ì¸
        function handleAdminLogin() {
            if (appState.adminPassword === 'admin2024' || appState.adminPassword === 'êµíšŒê´€ë¦¬ì') {
                updateStateImmediate({ isAdmin: true, showAdmin: true, adminPassword: '' });
            } else {
                alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                updateStateImmediate({ adminPassword: '' });
            }
        }

        // CSV ë‹¤ìš´ë¡œë“œ (í™•ì¥ëœ ì •ë³´ í¬í•¨)
        function downloadCSV() {
            if (appState.testHistory.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const headers = ['ë‚ ì§œ', 'ì‹œê°„', 'ì²«ë²ˆì§¸ ì´ë¦„', 'ì²«ë²ˆì§¸ MBTI', 'ì²«ë²ˆì§¸ ì„±ë³„', 'ì²«ë²ˆì§¸ ìƒë…„ì›”ì¼', 
                           'ë‘ë²ˆì§¸ ì´ë¦„', 'ë‘ë²ˆì§¸ MBTI', 'ë‘ë²ˆì§¸ ì„±ë³„', 'ë‘ë²ˆì§¸ ìƒë…„ì›”ì¼', 'ì¼€ë¯¸ ì ìˆ˜', 'ë‚˜ì´ì°¨ì´'];
            const csvData = appState.testHistory.map(record => [
                record.date, record.time, 
                record.person1.name, record.person1.mbti, record.person1.gender || '', record.person1.birthDate || '',
                record.person2.name, record.person2.mbti, record.person2.gender || '', record.person2.birthDate || '',
                record.score, record.ageDiff || ''
            ]);

            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `MBTI_ì¼€ë¯¸í…ŒìŠ¤íŠ¸_v2.0_${new Date().toLocaleDateString('ko-KR')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // í†µê³„ ê³„ì‚° (í™•ì¥ëœ ì •ë³´ í¬í•¨)
        function getStats() {
            if (appState.testHistory.length === 0) {
                return {
                    totalTests: 0,
                    averageScore: 0,
                    topMBTI: '',
                    topCombo: '',
                    todayTests: 0,
                    weekTests: 0,
                    genderStats: {},
                    averageAgeDiff: 0
                };
            }

            const today = new Date().toLocaleDateString('ko-KR');
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const todayTests = appState.testHistory.filter(record => record.date === today).length;
            const weekTests = appState.testHistory.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= oneWeekAgo;
            }).length;

            const totalScore = appState.testHistory.reduce((sum, record) => sum + record.score, 0);
            const mbtiCount = {};
            const comboCount = {};
            const genderStats = {};
            let totalAgeDiff = 0;
            let ageDiffCount = 0;

            appState.testHistory.forEach(record => {
                mbtiCount[record.person1.mbti] = (mbtiCount[record.person1.mbti] || 0) + 1;
                mbtiCount[record.person2.mbti] = (mbtiCount[record.person2.mbti] || 0) + 1;
                const combo = [record.person1.mbti, record.person2.mbti].sort().join('-');
                comboCount[combo] = (comboCount[combo] || 0) + 1;
                
                // ì„±ë³„ í†µê³„
                if (record.genderCombo) {
                    genderStats[record.genderCombo] = (genderStats[record.genderCombo] || 0) + 1;
                }
                
                // ë‚˜ì´ ì°¨ì´ í†µê³„
                if (record.ageDiff !== null && record.ageDiff !== undefined) {
                    totalAgeDiff += record.ageDiff;
                    ageDiffCount++;
                }
            });

            const topMBTI = Object.keys(mbtiCount).reduce((a, b) => mbtiCount[a] > mbtiCount[b] ? a : b, '');
            const topCombo = Object.keys(comboCount).reduce((a, b) => comboCount[a] > comboCount[b] ? a : b, '');

            return {
                totalTests: appState.testHistory.length,
                averageScore: Math.round(totalScore / appState.testHistory.length),
                topMBTI: topMBTI,
                topCombo: topCombo,
                todayTests: todayTests,
                weekTests: weekTests,
                genderStats: genderStats,
                averageAgeDiff: ageDiffCount > 0 ? Math.round(totalAgeDiff / ageDiffCount) : 0
            };
        }

        // HTML ìƒì„± í•¨ìˆ˜ë“¤ (onblurì—ì„œë§Œ ë Œë”ë§)
        function createInput(type, placeholder, value, onchange, className = '', id = '') {
            return `<input type="${type}" placeholder="${placeholder}" value="${value}" 
                ${id ? `id="${id}"` : ''}
                oninput="${onchange}" 
                onblur="render()"
                class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-600 focus:outline-none transition-colors ${className}">`;
        }

        function createSelect(value, onchange, options, className = '') {
            const optionHtml = options.map(opt => 
                `<option value="${opt.value}" ${opt.value === value ? 'selected' : ''}>${opt.text}</option>`
            ).join('');
            
            return `<select onchange="${onchange}" class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-600 focus:outline-none transition-colors ${className}">
                ${optionHtml}
            </select>`;
        }

        function createButton(text, onclick, className = '') {
            return `<button onclick="${onclick}" class="${className}">${text}</button>`;
        }

        // ==========================================
        // ğŸ¨ ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜ (UI í™•ì¥)
        // ==========================================

        function render() {
            const root = document.getElementById('root');
            
            // ê´€ë¦¬ì ë¡œê·¸ì¸ í™”ë©´ (ê¸°ì¡´ê³¼ ë™ì¼)
            if (appState.showAdmin && !appState.isAdmin) {
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">ğŸ‘‘</div>
                                <h2 class="text-2xl font-bold text-gray-800">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
                                <p class="text-gray-600 mt-2">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                            </div>
                            <div class="space-y-4">
                                ${createInput('password', 'ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸', appState.adminPassword, 
                                    "updateState({adminPassword: this.value})", 
                                    'onkeypress="if(event.key===\'Enter\')handleAdminLogin()"', 'admin-password')}
                                ${createButton('ë¡œê·¸ì¸', 'handleAdminLogin()', 
                                    'w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-2xl hover:from-purple-700 hover:to-indigo-700 transition-all duration-200')}
                                ${createButton('ì·¨ì†Œ', 'updateStateImmediate({showAdmin: false, adminPassword: ""})', 
                                    'w-full bg-gray-100 text-gray-700 font-medium py-3 px-6 rounded-2xl hover:bg-gray-200 transition-all')}
                            </div>
                            <div class="mt-6 p-3 bg-blue-50 rounded-xl text-center">
                                <p class="text-xs text-blue-600">ğŸ’¡ íŒíŠ¸: ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸ëŠ” "admin2024" ë˜ëŠ” "êµíšŒê´€ë¦¬ì" ì…ë‹ˆë‹¤</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (í™•ì¥ëœ í†µê³„ í¬í•¨)
            if (appState.showAdmin && appState.isAdmin) {
                const stats = getStats();
                
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-50 p-4">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center">
                                        <span class="text-3xl mr-3">ğŸ‘‘</span>
                                        <h1 class="text-3xl font-bold text-gray-800">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ v2.0</h1>
                                        <span class="ml-3 px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full font-medium">ì„±ë³„&ë‚˜ì´ ì—…ê·¸ë ˆì´ë“œ</span>
                                    </div>
                                    ${createButton('ë¡œê·¸ì•„ì›ƒ', 'updateStateImmediate({isAdmin: false, showAdmin: false})', 
                                        'bg-red-100 text-red-700 px-4 py-2 rounded-xl hover:bg-red-200 transition-all')}
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-xl">ğŸ”</span>
                                        ${createInput('text', 'ì´ë¦„ ë˜ëŠ” MBTIë¡œ ê²€ìƒ‰...', appState.searchTerm, 
                                            'updateState({searchTerm: this.value})', 'pl-10', 'admin-search')}
                                    </div>
                                    ${createSelect(appState.dateFilter, 'updateStateImmediate({dateFilter: this.value})', [
                                        {value: 'all', text: 'ì „ì²´ ê¸°ê°„'},
                                        {value: 'today', text: 'ì˜¤ëŠ˜'},
                                        {value: 'week', text: 'ìµœê·¼ 1ì£¼ì¼'},
                                        {value: 'month', text: 'ìµœê·¼ 1ê°œì›”'}
                                    ])}
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold text-gray-700">ì´ í…ŒìŠ¤íŠ¸ ìˆ˜</h3>
                                        <span class="text-2xl">ğŸ“Š</span>
                                    </div>
                                    <div class="text-3xl font-bold text-blue-600">${stats.totalTests}</div>
                                    <p class="text-sm text-gray-500 mt-2">ì „ì²´ ì¼€ë¯¸ í…ŒìŠ¤íŠ¸ íšŸìˆ˜</p>
                                </div>

                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold text-gray-700">í‰ê·  ì¼€ë¯¸ ì ìˆ˜</h3>
                                        <span class="text-2xl">ğŸ“ˆ</span>
                                    </div>
                                    <div class="text-3xl font-bold text-green-600">${stats.averageScore}ì </div>
                                    <p class="text-sm text-gray-500 mt-2">ì „ì²´ í…ŒìŠ¤íŠ¸ í‰ê· </p>
                                </div>

                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold text-gray-700">í‰ê·  ë‚˜ì´ ì°¨ì´</h3>
                                        <span class="text-2xl">ğŸ‚</span>
                                    </div>
                                    <div class="text-3xl font-bold text-purple-600">${stats.averageAgeDiff}ì‚´</div>
                                    <p class="text-sm text-gray-500 mt-2">í…ŒìŠ¤íŠ¸ ì°¸ì—¬ì í‰ê·  ë‚˜ì´ ì°¨ì´</p>
                                </div>

                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold text-gray-700">ì¸ê¸° ì¡°í•©</h3>
                                        <span class="text-2xl">ğŸ’•</span>
                                    </div>
                                    <div class="text-xl font-bold text-red-600">${stats.topCombo || '-'}</div>
                                    <p class="text-sm text-gray-500 mt-2">ê°€ì¥ ë§ì´ í…ŒìŠ¤íŠ¸ëœ MBTI ì¡°í•©</p>
                                </div>

                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold text-gray-700">ì„±ë³„ ì¡°í•© í†µê³„</h3>
                                        <span class="text-2xl">ğŸ‘«</span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        ${Object.entries(stats.genderStats).map(([combo, count]) => {
                                            const display = combo === 'male-female' || combo === 'female-male' ? 'ì´ì„±' :
                                                          combo === 'male-male' ? 'ë‚¨ì„±' :
                                                          combo === 'female-female' ? 'ì—¬ì„±' : combo;
                                            return `<div class="flex justify-between"><span>${display}:</span><span class="font-medium">${count}íšŒ</span></div>`;
                                        }).join('') || '<div class="text-gray-400">ë°ì´í„° ì—†ìŒ</div>'}
                                    </div>
                                </div>

                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold text-gray-700">ìµœë‹¤ ì°¸ì—¬ MBTI</h3>
                                        <span class="text-2xl">â­</span>
                                    </div>
                                    <div class="text-3xl font-bold text-yellow-600">${stats.topMBTI || '-'}</div>
                                    <p class="text-sm text-gray-500 mt-2">ê°€ì¥ ë§ì´ í…ŒìŠ¤íŠ¸í•œ ìœ í˜•</p>
                                </div>

                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold text-gray-700">ì˜¤ëŠ˜ í…ŒìŠ¤íŠ¸</h3>
                                        <span class="text-2xl">ğŸ“…</span>
                                    </div>
                                    <div class="text-3xl font-bold text-purple-600">${stats.todayTests}</div>
                                    <p class="text-sm text-gray-500 mt-2">ê¸ˆì¼ ì§„í–‰ëœ í…ŒìŠ¤íŠ¸</p>
                                </div>

                                <div class="bg-white rounded-2xl shadow-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-semibold text-gray-700">ì´ë²ˆ ì£¼ í…ŒìŠ¤íŠ¸</h3>
                                        <span class="text-2xl">ğŸ“Š</span>
                                    </div>
                                    <div class="text-3xl font-bold text-indigo-600">${stats.weekTests}</div>
                                    <p class="text-sm text-gray-500 mt-2">ìµœê·¼ 7ì¼ê°„ í…ŒìŠ¤íŠ¸</p>
                                </div>
                            </div>

                            <div class="bg-white rounded-3xl shadow-xl p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-2xl font-bold text-gray-800">ìƒì„¸ ê¸°ë¡ (v2.0 í™•ì¥)</h2>
                                    <div class="text-sm text-gray-500">ì´ ${appState.testHistory.length}ê°œ ê¸°ë¡</div>
                                </div>
                                
                                ${appState.testHistory.length === 0 ? 
                                    '<div class="text-center py-12 text-gray-500">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>' :
                                    `<div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b-2 border-gray-200">
                                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">ë‚ ì§œ</th>
                                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">ì‹œê°„</th>
                                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">ì²« ë²ˆì§¸</th>
                                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">ë‘ ë²ˆì§¸</th>
                                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">ì¼€ë¯¸ ì ìˆ˜</th>
                                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">ì„±ë³„ ì¡°í•©</th>
                                                    <th class="text-center py-3 px-4 font-semibold text-gray-700">ë‚˜ì´ ì°¨ì´</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${appState.testHistory.map((record, index) => {
                                                    const genderDisplay = record.genderCombo ? 
                                                        (record.genderCombo === 'male-female' || record.genderCombo === 'female-male' ? 'ì´ì„±' :
                                                         record.genderCombo === 'male-male' ? 'ë‚¨ì„±' : 'ì—¬ì„±') : '-';
                                                    const ageDiffDisplay = record.ageDiff !== null && record.ageDiff !== undefined ? 
                                                        `${record.ageDiff}ì‚´` : '-';
                                                    
                                                    return `
                                                    <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                                                        <td class="py-3 px-4">${record.date}</td>
                                                        <td class="py-3 px-4">${record.time}</td>
                                                        <td class="py-3 px-4">${record.person1.name} (${record.person1.mbti})</td>
                                                        <td class="py-3 px-4">${record.person2.name} (${record.person2.mbti})</td>
                                                        <td class="py-3 px-4 text-center">
                                                            <span class="font-bold ${getScoreColor(record.score)}">${record.score}ì  ${getScoreEmoji(record.score)}</span>
                                                        </td>
                                                        <td class="py-3 px-4 text-center">${genderDisplay}</td>
                                                        <td class="py-3 px-4 text-center">${ageDiffDisplay}</td>
                                                    </tr>
                                                `;}).join('')}
                                            </tbody>
                                        </table>
                                        
                                        <div class="mt-6 pt-6 border-t border-gray-200">
                                            <h3 class="font-medium text-gray-700 mb-3">ê´€ë¦¬ì ë„êµ¬</h3>
                                            <div class="flex space-x-3">
                                                ${createButton('ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ (í™•ì¥)', 'downloadCSV()', 
                                                    'flex-1 bg-green-100 text-green-700 font-medium py-3 px-4 rounded-2xl hover:bg-green-200 transition-all')}
                                                ${createButton('ğŸ—‘ï¸ ëª¨ë“  ê¸°ë¡ ì‚­ì œ', 
                                                    'if(confirm("ì •ë§ë¡œ ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem("mbtiChemistryHistory"); updateState({testHistory: []}); alert("ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); }', 
                                                    'flex-1 bg-red-100 text-red-700 font-medium py-3 px-4 rounded-2xl hover:bg-red-200 transition-all')}
                                            </div>
                                        </div>
                                    </div>`
                                }
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // ì„¤ì • í™”ë©´ (ì—…ë°ì´íŠ¸ëœ ë²„ì „)
            if (appState.showSettings) {
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                        <div class="max-w-md mx-auto">
                            <div class="bg-white rounded-3xl shadow-xl p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                        <span class="text-2xl mr-2">âš™ï¸</span>
                                        ì„¤ì •
                                    </h2>
                                    ${createButton('âœ•', 'updateStateImmediate({showSettings: false})', 
                                        'text-gray-500 hover:text-gray-700 text-2xl')}
                                </div>
                                
                                <div class="space-y-4">
                                    <div class="text-center">
                                        <h3 class="font-medium text-gray-700 mb-4">ê´€ë¦¬ì ë„êµ¬</h3>
                                        ${createButton('ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ', 'updateStateImmediate({showAdmin: true, showSettings: false})', 
                                            'w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-2xl hover:from-purple-700 hover:to-indigo-700 transition-all duration-200')}
                                        <p class="text-xs text-gray-500 mt-2">
                                            ğŸ“Š ì „ì²´ í†µê³„, ì„±ë³„&ë‚˜ì´ ë¶„ì„, CSV ë‹¤ìš´ë¡œë“œ
                                        </p>
                                    </div>
                                    
                                    <div class="border-t pt-4">
                                        <h3 class="font-medium text-gray-700 mb-3">ì•± ì •ë³´</h3>
                                        <div class="bg-blue-50 rounded-xl p-4 text-center">
                                            <p class="text-sm text-blue-800 font-medium mb-2">ğŸ›ï¸ êµíšŒ MBTI ì¼€ë¯¸ ì²´í¬ v2.0</p>
                                            <p class="text-xs text-blue-600">
                                                âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥<br>
                                                â€¢ ì„±ë³„ ì¡°í•©ë³„ íŠ¹í™” ë©”ì‹œì§€<br>
                                                â€¢ ë‚˜ì´ ì°¨ì´ ê¸°ë°˜ ê´€ê³„ ë¶„ì„<br>
                                                â€¢ í™•ì¥ëœ í†µê³„ ëŒ€ì‹œë³´ë“œ<br>
                                                â€¢ ê°œì¸í™”ëœ ì¼€ë¯¸ ê³„ì‚°
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                ${createButton('ì™„ë£Œ', 'updateStateImmediate({showSettings: false})', 
                                    'w-full mt-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-6 rounded-2xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200')}
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // ê¸°ë¡ ë³´ê¸° í™”ë©´ (í™•ì¥ëœ ì •ë³´ í‘œì‹œ)
            if (appState.showHistory) {
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                        <div class="max-w-md mx-auto">
                            <div class="bg-white rounded-3xl shadow-xl p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                        <span class="text-2xl mr-2">ğŸ“‹</span>
                                        ì¼€ë¯¸ í…ŒìŠ¤íŠ¸ ê¸°ë¡ v2.0
                                    </h2>
                                    <div class="flex space-x-2">
                                        ${createButton('âš™ï¸', 'updateState({showSettings: true})', 
                                            'p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-100')}
                                        ${createButton('âœ•', 'updateState({showHistory: false})', 
                                            'text-gray-500 hover:text-gray-700 text-xl')}
                                    </div>
                                </div>
                                
                                ${appState.testHistory.length === 0 ? 
                                    '<div class="text-center py-8"><p class="text-gray-500">ì•„ì§ í…ŒìŠ¤íŠ¸ ê¸°ë¡ì´ ì—†ì–´ìš”</p></div>' :
                                    `<div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${appState.testHistory.map(record => {
                                            const genderInfo = record.genderCombo ? 
                                                `<span class="text-xs px-2 py-1 rounded-full ${
                                                    record.genderCombo === 'male-female' || record.genderCombo === 'female-male' ? 
                                                    'bg-pink-100 text-pink-600' : 'bg-blue-100 text-blue-600'
                                                }">${
                                                    record.genderCombo === 'male-female' || record.genderCombo === 'female-male' ? 'ì´ì„±' :
                                                    record.genderCombo === 'male-male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'
                                                }</span>` : '';
                                            
                                            const ageInfo = record.ageDiff !== null && record.ageDiff !== undefined ? 
                                                `<span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-600">${record.ageDiff}ì‚´ì°¨ì´</span>` : '';
                                            
                                            return `
                                            <div class="bg-gray-50 rounded-2xl p-4">
                                                <div class="flex items-center justify-between mb-2">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="font-medium text-blue-600">${maskName(record.person1.name)}</span>
                                                        <span class="text-xs text-gray-500">(${record.person1.mbti})</span>
                                                        <span class="text-red-500">ğŸ’•</span>
                                                        <span class="font-medium text-purple-600">${maskName(record.person2.name)}</span>
                                                        <span class="text-xs text-gray-500">(${record.person2.mbti})</span>
                                                    </div>
                                                    <span class="font-bold ${getScoreColor(record.score)}">
                                                        ${record.score}ì  ${getScoreEmoji(record.score)}
                                                    </span>
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <div class="text-xs text-gray-500">
                                                        ${record.date} ${record.time}
                                                    </div>
                                                    <div class="flex space-x-1">
                                                        ${genderInfo}
                                                        ${ageInfo}
                                                    </div>
                                                </div>
                                            </div>
                                        `;}).join('')}
                                    </div>`
                                }
                                
                                ${createButton('ëŒì•„ê°€ê¸°', 'updateStateImmediate({showHistory: false})', 
                                    'w-full mt-6 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-6 rounded-2xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200')}
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // ë¡œë”© í™”ë©´ (ê¸°ì¡´ê³¼ ë™ì¼)
            if (appState.currentStep === 'loading') {
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent mx-auto mb-6"></div>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">ì¼€ë¯¸ ë¶„ì„ ì¤‘...</h2>
                            <p class="text-gray-600">ì„±ë³„ê³¼ ë‚˜ì´ê¹Œì§€ ê³ ë ¤í•œ ì •ë°€ ë¶„ì„ì„ ì§„í–‰í•˜ê³  ìˆì–´ìš”!</p>
                        </div>
                    </div>
                `;
                return;
            }

            // ê²°ê³¼ í™”ë©´ (í™•ì¥ëœ ì •ë³´ í‘œì‹œ)
            if (appState.currentStep === 'result') {
                const hasGenderInfo = appState.person1.gender && appState.person2.gender;
                const hasAgeInfo = appState.person1.birthDate && appState.person2.birthDate;
                
                root.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                        ${appState.showCelebration ? `
                            <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                                <div class="bg-white rounded-3xl p-8 max-w-sm mx-4 text-center animate-bounce">
                                    <div class="text-6xl mb-4">ğŸ‰</div>
                                    <div class="text-3xl mb-2">ğŸ†</div>
                                    <h2 class="text-2xl font-bold text-yellow-600 mb-2">í™˜ìƒì˜ ì¼€ë¯¸!</h2>
                                    <p class="text-gray-700 mb-4">90ì  ì´ìƒì˜ ë†€ë¼ìš´ ê¶í•©ì´ì—ìš”!</p>
                                    <div class="flex justify-center space-x-2">
                                        ${'â­'.repeat(5)}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="max-w-md mx-auto">
                            <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                                <div class="text-center mb-6">
                                    <div class="flex items-center justify-center mb-4">
                                        <span class="text-3xl mr-2">âœ¨</span>
                                        <h1 class="text-2xl font-bold text-gray-800">ì¼€ë¯¸ ë¶„ì„ ê²°ê³¼ v2.0</h1>
                                        ${createButton('ğŸ“‹', 'updateStateImmediate({showHistory: true})', 
                                            'ml-4 p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-100')}
                                    </div>
                                    <div class="flex items-center justify-center space-x-2 mb-2">
                                        <span class="text-lg font-semibold text-blue-600">${appState.person1.name}</span>
                                        <span class="text-sm text-gray-500">(${appState.person1.mbti})</span>
                                        <span class="text-red-500">ğŸ’•</span>
                                        <span class="text-lg font-semibold text-blue-600">${appState.person2.name}</span>
                                        <span class="text-sm text-gray-500">(${appState.person2.mbti})</span>
                                    </div>
                                    
                                    ${hasGenderInfo || hasAgeInfo ? `
                                        <div class="flex justify-center space-x-2 mb-4">
                                            ${hasGenderInfo ? `
                                                <span class="text-xs px-3 py-1 rounded-full ${
                                                    appState.person1.gender !== appState.person2.gender ? 
                                                    'bg-pink-100 text-pink-600' : 'bg-blue-100 text-blue-600'
                                                }">
                                                    ${appState.person1.gender !== appState.person2.gender ? 'ì´ì„± ì¡°í•©' : 'ë™ì„± ì¡°í•©'}
                                                </span>
                                            ` : ''}
                                            ${hasAgeInfo ? `
                                                <span class="text-xs px-3 py-1 bg-green-100 text-green-600 rounded-full">
                                                    ${Math.abs(calculateAge(appState.person1.birthDate) - calculateAge(appState.person2.birthDate))}ì‚´ ì°¨ì´
                                                </span>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="text-center mb-6">
                                    ${appState.result.overall >= 90 ? `
                                        <div class="mb-4">
                                            <div class="text-4xl mb-2">ğŸ‰ğŸ†ğŸ‰</div>
                                            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-full inline-block text-sm font-bold">
                                                PERFECT MATCH!
                                            </div>
                                        </div>
                                    ` : ''}
                                    <div class="text-5xl font-bold ${getScoreColor(appState.result.overall)} mb-2">
                                        ${appState.result.overall}ì  ${getScoreEmoji(appState.result.overall)}
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full transition-all duration-1000" 
                                             style="width: ${appState.result.overall}%"></div>
                                    </div>
                                    <p class="text-gray-700 leading-relaxed">${appState.result.message}</p>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                ${[
                                    { key: 'travel', label: 'ì—¬í–‰ ë™ë°˜ì ì¼€ë¯¸', color: 'from-green-500 to-emerald-600', icon: 'ğŸ—ºï¸' },
                                    { key: 'faith', label: 'ì‹ ì•™ ì„±ì¥ íŒŒíŠ¸ë„ˆ ì¼€ë¯¸', color: 'from-blue-500 to-indigo-600', icon: 'ğŸ“–' },
                                    { key: 'conversation', label: 'ì¼ìƒ ëŒ€í™” íŒŒíŠ¸ë„ˆ ì¼€ë¯¸', color: 'from-purple-500 to-pink-600', icon: 'ğŸ’¬' },
                                    { key: 'teamwork', label: 'ì†Œê·¸ë£¹ í™œë™ íŒŒíŠ¸ë„ˆ ì¼€ë¯¸', color: 'from-orange-500 to-red-600', icon: 'ğŸ‘¥' },
                                    { key: 'service', label: 'ë´‰ì‚¬ ë™ì—­ì ì¼€ë¯¸', color: 'from-teal-500 to-cyan-600', icon: 'ğŸ¤' }
                                ].map(item => `
                                    <div class="bg-white rounded-2xl shadow-lg p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center">
                                                <span class="text-xl mr-2">${item.icon}</span>
                                                <span class="font-medium text-gray-800">${item.label}</span>
                                            </div>
                                            <span class="font-bold ${getScoreColor(appState.result.detailed[item.key])}">
                                                ${appState.result.detailed[item.key]}ì 
                                            </span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-gradient-to-r ${item.color} h-2 rounded-full transition-all duration-1000" 
                                                 style="width: ${appState.result.detailed[item.key]}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="flex space-x-3">
                                ${createButton('ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°', 'resetTest()', 
                                    'flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-6 rounded-2xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg')}
                                ${createButton('ê³µìœ í•˜ê¸°', `
                                    const genderInfo = '${hasGenderInfo ? (appState.person1.gender !== appState.person2.gender ? ' (ì´ì„±ì¡°í•©)' : ' (ë™ì„±ì¡°í•©)') : ''}';
                                    const ageInfo = '${hasAgeInfo ? ` (${Math.abs(calculateAge(appState.person1.birthDate) - calculateAge(appState.person2.birthDate))}ì‚´ì°¨ì´)` : ''}';
                                    const text = '${appState.person1.name}(${appState.person1.mbti})ë‹˜ê³¼ ${appState.person2.name}(${appState.person2.mbti})ë‹˜ì˜ ì¼€ë¯¸ëŠ” ${appState.result.overall}ì ! ğŸ”¥' + genderInfo + ageInfo;
                                    if (navigator.share) {
                                        navigator.share({title: 'MBTI ì¼€ë¯¸ ì²´í¬ v2.0 ê²°ê³¼', text: text});
                                    } else {
                                        navigator.clipboard.writeText(text);
                                        alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                                    }
                                `, 'bg-white border-2 border-blue-600 text-blue-600 font-bold py-3 px-6 rounded-2xl hover:bg-blue-50 transition-all duration-200 shadow-lg')}
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // ë©”ì¸ ì…ë ¥ í™”ë©´ (í™•ì¥ëœ í•„ë“œ í¬í•¨)
            root.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4">
                    <div class="max-w-md mx-auto">
                        <div class="text-center mb-8 pt-8">
                            <div class="flex items-center justify-center mb-4">
                                <span class="text-2xl mr-2">ğŸ’•</span>
                                <h1 class="text-xl md:text-3xl font-bold text-gray-800">MBTI ì¼€ë¯¸ ì²´í¬ v2.0</h1>
                                <div class="flex ml-4 space-x-2">
                                    ${createButton('ğŸ“‹', 'updateState({showHistory: true})', 
                                        'p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-white hover:shadow-md transition-all cursor-pointer')}
                                    ${createButton('âš™ï¸', 'updateState({showSettings: true})', 
                                        'p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-white hover:shadow-md transition-all cursor-pointer')}
                                </div>
                            </div>
                            <p class="text-gray-600">ì„±ë³„ê³¼ ë‚˜ì´ê¹Œì§€ ê³ ë ¤í•œ ì •ë°€ ì¼€ë¯¸ ë¶„ì„!</p>
                            <div class="mt-2 px-4 py-2 bg-blue-100 text-blue-800 rounded-full inline-block text-sm font-medium">
                                âœ¨ ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ: ê°œì¸í™”ëœ ë§¤ì¹­ ì‹œìŠ¤í…œ
                            </div>
                            ${appState.testHistory.length > 0 ? 
                                `<p class="text-sm text-blue-600 mt-2">ğŸ’¾ ${appState.testHistory.length}ê°œì˜ í…ŒìŠ¤íŠ¸ ê¸°ë¡ì´ ìˆì–´ìš”</p>` : ''}
                        </div>

                        <div class="bg-white rounded-3xl shadow-xl p-6 mb-6">
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">1</span>
                                    ì²« ë²ˆì§¸ ë¶„
                                </h3>
                                <div class="space-y-4">
                                    ${createInput('text', 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', appState.person1.name, 
                                        'updateState({person1: {...appState.person1, name: this.value}})', '', 'person1-name')}
                                    ${createSelect(appState.person1.mbti, 'updateStateImmediate({person1: {...appState.person1, mbti: this.value}})', 
                                        [{value: '', text: 'MBTI ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”'}, ...mbtiTypes.map(type => ({value: type, text: type}))])}
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        ${createSelect(appState.person1.gender, 'updateStateImmediate({person1: {...appState.person1, gender: this.value}})', genderOptions)}
                                        ${createInput('date', 'ìƒë…„ì›”ì¼', appState.person1.birthDate, 
                                            'updateState({person1: {...appState.person1, birthDate: this.value}})', '', 'person1-birth')}
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">ğŸ’¡ ì„±ë³„ê³¼ ìƒë…„ì›”ì¼ì€ ì„ íƒì‚¬í•­ì´ì§€ë§Œ, ì…ë ¥í•˜ì‹œë©´ ë” ì •í™•í•œ ì¼€ë¯¸ ë¶„ì„ì´ ê°€ëŠ¥í•´ìš”!</p>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <span class="bg-purple-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">2</span>
                                    ë‘ ë²ˆì§¸ ë¶„
                                </h3>
                                <div class="space-y-4">
                                    ${createInput('text', 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', appState.person2.name, 
                                        'updateState({person2: {...appState.person2, name: this.value}})', '', 'person2-name')}
                                    ${createSelect(appState.person2.mbti, 'updateStateImmediate({person2: {...appState.person2, mbti: this.value}})', 
                                        [{value: '', text: 'MBTI ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”'}, ...mbtiTypes.map(type => ({value: type, text: type}))])}
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        ${createSelect(appState.person2.gender, 'updateStateImmediate({person2: {...appState.person2, gender: this.value}})', genderOptions)}
                                        ${createInput('date', 'ìƒë…„ì›”ì¼', appState.person2.birthDate, 
                                            'updateState({person2: {...appState.person2, birthDate: this.value}})', '', 'person2-birth')}
                                    </div>
                                </div>
                            </div>

                            ${createButton('ì¼€ë¯¸ í™•ì¸í•˜ê¸° â†’', 'handleSubmit()', 
                                'w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-4 px-6 rounded-2xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200 shadow-lg')}
                        </div>

                        <div class="bg-white/70 backdrop-blur-sm rounded-2xl p-4 text-center">
                            <p class="text-sm text-gray-600">
                                ğŸ¯ 5ê°œ ì˜ì—­ë³„ ì„¸ë¶€ ì¼€ë¯¸ ë¶„ì„<br>
                                âœ¨ ì„±ë³„ ì¡°í•©ë³„ íŠ¹í™” ë©”ì‹œì§€<br>
                                ğŸ‚ ë‚˜ì´ ì°¨ì´ ê¸°ë°˜ ê´€ê³„ ë¶„ì„<br>
                                ğŸ’ êµíšŒ ê³µë™ì²´ë¥¼ ìœ„í•œ íŠ¹ë³„í•œ ì¼€ë¯¸ ì²´í¬
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // ì´ˆê¸° ë¡œë“œ
        window.onload = function() {
            loadFromStorage();
            render();
        };
    </script>
</body>
</html>
